#include "FreeRTOS.h"
#include "task.h"
#include "cmsis_os.h"
#include "stm32f2xx_hal.h"
#include "adc.h"
#include "math_func.h"

uint16_t Circ_buffer_median(uint16_t *buffer, uint16_t newValue) {
  uint16_t i;
  uint16_t len;

  len = sizeof(buffer) / 2;
  for (i = len - 1; i > 0; i--) {
    buffer[i] = buffer[i - 1];
  }
  buffer[0] = newValue;
  return Mediana_filter16(buffer, len);
}

unsigned short Mediana_filter16(unsigned short *M_Pointer, unsigned char qty) {
  unsigned short mediana_masive[17];
  unsigned char i;
  unsigned short temp, max = 0;
  unsigned char pmax, high;

  for (i = 0; i < qty; i++) { // ???????????? ????, ????? ?? ??????? ????????
    mediana_masive[i] = *M_Pointer++;
  }

  high = (qty - 1); //????????, ??? ????????? ??????? ????? ???????

  //???? ???? ??????? ???????? ?????? ??? ????? ???? - ?????? ?? ??????? ?
  //???????? ????????? ?? ?????
  //????? ???????? ?? ??????? ????, ? ??? ???? ?? ?????? ?? ????.

  while (high !=
         0) { //(?.?. ???? ?? ?????? ?????????, ? ????????? 0 ????? 255 (0xFF)

    //??????????
    temp = 1; //??????? ??? ?????????? ???? ????

    while (temp != 0) {
      pmax = high; // ???????, ??? ???? ???????????? ??? ?????????
      temp = 0;    //???????, ??? ??? ???????????? ???, ?? ? ?????????? ???????
                   //?????? ???
      for (i = 0; i < high; i++) {

        if (mediana_masive[i] > mediana_masive[pmax]) { //???? ??????

          /*?????? ???????*/
          max = mediana_masive[pmax];
          mediana_masive[pmax] = mediana_masive[i];
          mediana_masive[i] = max;
          temp++;
        }
      }
    }

    //??? ?? ???, ?????? ??? ????????????
    high--; //????????? ???? ?????? ? ??????????? ??? ? ??????? ???????????
  }

  return mediana_masive[qty / 2];
}
